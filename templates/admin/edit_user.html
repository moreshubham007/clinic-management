{% extends "base.html" %}

{% block title %}Edit User - Clinic Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">Edit User</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('admin.manage_users') }}">Users</a></li>
                            <li class="breadcrumb-item active">Edit User</li>
                        </ol>
                    </nav>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('admin.manage_users') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Users
                    </a>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">User Information</h5>
                        <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                            {{ 'Active' if user.is_active else 'Inactive' }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        <!-- Basic Information Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label for="name" class="form-label fw-bold">Full Name</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ user.name }}" required
                                           pattern="[A-Za-z\s]+" minlength="2" maxlength="100">
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid name (2-100 characters, letters only).
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label fw-bold">Email Address</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ user.email }}" required>
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid email address.
                                </div>
                            </div>
                        </div>

                        <!-- Role and Password Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-4">
                                <label for="role" class="form-label fw-bold">User Role</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrator</option>
                                        <option value="doctor" {% if user.role == 'doctor' %}selected{% endif %}>Doctor</option>
                                        <option value="receptionist" {% if user.role == 'receptionist' %}selected{% endif %}>Receptionist</option>
                                        <option value="patient" {% if user.role == 'patient' %}selected{% endif %}>Patient</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="password" class="form-label fw-bold">New Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="password" name="password"
                                           minlength="8" maxlength="100">
                                </div>
                                <small class="text-muted">Leave blank to keep current password</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Account Status</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="is_active" 
                                           name="is_active" {% if user.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">Active Account</label>
                                </div>
                            </div>
                        </div>

                        <!-- Patient Fields Section -->
                        <div id="patient-fields" class="{% if user.role != 'patient' %}d-none{% endif %}">
                            <hr class="my-4">
                            <h5 class="mb-4">Patient Details</h5>
                            
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <label for="patient_number" class="form-label fw-bold">Patient ID</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                        <input type="text" class="form-control" id="patient_number" name="patient_number" 
                                               value="{{ user.patient_number }}" {% if user.role == 'patient' %}required{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="mobile_number" class="form-label fw-bold">Mobile Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input type="text" class="form-control" id="mobile_number" name="mobile_number" 
                                               value="{{ user.mobile_number }}" pattern="[0-9]{10}" 
                                               title="Please enter a valid 10-digit mobile number" 
                                               {% if user.role == 'patient' %}required{% endif %}>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <label for="date_of_birth" class="form-label fw-bold">Date of Birth</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" 
                                               value="{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '' }}" 
                                               {% if user.role == 'patient' %}required{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="aadhar_number" class="form-label fw-bold">Aadhar Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-fingerprint"></i></span>
                                        <input type="text" class="form-control" id="aadhar_number" name="aadhar_number" 
                                               value="{{ user.aadhar_number }}" pattern="[0-9]{12}" 
                                               title="Please enter a valid 12-digit Aadhar number" 
                                               {% if user.role == 'patient' %}required{% endif %}>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mb-4">
                                <div class="col-12">
                                    <label for="address" class="form-label fw-bold">Address</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-home"></i></span>
                                        <textarea class="form-control" id="address" name="address" rows="3" 
                                                  {% if user.role == 'patient' %}required{% endif %}>{{ user.address }}</textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mb-4">
                                <div class="col-md-4">
                                    <label for="state" class="form-label fw-bold">State</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map"></i></span>
                                        <select class="form-select" id="state" name="state" {% if user.role == 'patient' %}required{% endif %}>
                                            <option value="">Select State</option>
                                            <option value="Andhra Pradesh" {% if user.state == 'Andhra Pradesh' %}selected{% endif %}>Andhra Pradesh</option>
                                            <option value="Maharashtra" {% if user.state == 'Maharashtra' %}selected{% endif %}>Maharashtra</option>
                                            <!-- Add more states -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="city" class="form-label fw-bold">City</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-city"></i></span>
                                        <input type="text" class="form-control" id="city" name="city" 
                                               value="{{ user.city }}" {% if user.role == 'patient' %}required{% endif %}>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="pin_code" class="form-label fw-bold">PIN Code</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                                        <input type="text" class="form-control" id="pin_code" name="pin_code" 
                                               value="{{ user.pin_code }}" pattern="[0-9]{6}" 
                                               title="Please enter a valid 6-digit PIN code" 
                                               {% if user.role == 'patient' %}required{% endif %}>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Doctor Fields Section -->
                        <div id="doctor-fields" class="{% if user.role != 'doctor' %}d-none{% endif %}">
                            <hr class="my-4">
                            <h5 class="mb-4">Doctor Details</h5>
                            
                            <div class="row g-4 mb-4">
                                <div class="col-12">
                                    <label for="specialization" class="form-label fw-bold">Specialization</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-stethoscope"></i></span>
                                        <input type="text" class="form-control" id="specialization" 
                                               name="specialization" 
                                               value="{{ user.doctor.specialization if user.doctor else '' }}"
                                               {% if user.role == 'doctor' %}required{% endif %}>
                                    </div>
                                </div>
                            </div>

                            <!-- Availability Section -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Weekly Availability Schedule</h6>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="copyToAllDays">
                                                <i class="fas fa-copy"></i> Copy to All Days
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearAll">
                                                <i class="fas fa-trash"></i> Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Time Range Selector -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Quick Time Range</label>
                                        <div class="row g-2">
                                            <div class="col-md-3">
                                                <select class="form-select" id="quickStartTime">
                                                    <option value="">Start Time</option>
                                                    {% for hour in range(0, 24) %}
                                                        {% for minute in [0, 30] %}
                                                            <option value="{{ '%02d:%02d'|format(hour, minute) }}">
                                                                {{ '%02d:%02d'|format(hour, minute) }}
                                                            </option>
                                                        {% endfor %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="quickEndTime">
                                                    <option value="">End Time</option>
                                                    {% for hour in range(0, 24) %}
                                                        {% for minute in [0, 30] %}
                                                            <option value="{{ '%02d:%02d'|format(hour, minute) }}">
                                                                {{ '%02d:%02d'|format(hour, minute) }}
                                                            </option>
                                                        {% endfor %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <select class="form-select" id="timeInterval">
                                                    <option value="30">30 min slots</option>
                                                    <option value="60">1 hour slots</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <button type="button" class="btn btn-primary w-100" id="applyTimeRange">
                                                    Apply to Selected Day
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <input type="hidden" id="availability" name="availability" 
                                           value="{{ user.doctor.availability|tojson if user.doctor else '{}' }}">
                                           
                                    <!-- Days of Week -->
                                    {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                                    <div class="card mb-3 availability-day" data-day="{{ day.lower() }}">
                                        <div class="card-header bg-light py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="form-check">
                                                    <input class="form-check-input day-checkbox" type="checkbox" 
                                                           id="check_{{ day.lower() }}" name="day_enabled[]"
                                                           value="{{ day.lower() }}" checked>
                                                    <label class="form-check-label" for="check_{{ day.lower() }}">
                                                        <strong>{{ day }}</strong>
                                                    </label>
                                                </div>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-sm btn-outline-primary copy-day">
                                                        <i class="fas fa-copy"></i> Copy
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger clear-day">
                                                        <i class="fas fa-trash"></i> Clear
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="selected-slots">
                                                <!-- Time slots will be displayed here -->
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <hr class="my-4">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-light">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const availabilityInput = document.getElementById('availability');
    
    // Initialize availability data for all days
    let availabilityData = {
        monday: [],
        tuesday: [],
        wednesday: [],
        thursday: [],
        friday: [],
        saturday: [],
        sunday: []
    };

    // Load existing availability data
    try {
        const existingData = availabilityInput.value;
        if (existingData && existingData !== '{}') {
            const parsedData = JSON.parse(existingData);
            console.log('Loaded availability data:', parsedData);
            
            // Initialize all days
            const allDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            allDays.forEach(day => {
                const dayElement = document.querySelector(`[data-day="${day}"]`);
                if (dayElement) {
                    const checkbox = dayElement.querySelector('.day-checkbox');
                    const slotsContainer = dayElement.querySelector('.selected-slots');
                    
                    // Clear existing slots
                    slotsContainer.innerHTML = '';
                    
                    // If day has slots, check the box and add slots
                    if (parsedData[day] && parsedData[day].length > 0) {
                        checkbox.checked = true;
                        parsedData[day].forEach(slot => {
                            addTimeSlotElement(slotsContainer, slot, day);
                        });
                    } else {
                        checkbox.checked = false;
                    }
                }
            });
            
            // Update availabilityData object
            availabilityData = parsedData;
        }
    } catch (e) {
        console.error('Error loading existing availability:', e);
        console.error('Raw value:', availabilityInput.value);
    }

    // Quick time range functionality
    const quickStartTime = document.getElementById('quickStartTime');
    const quickEndTime = document.getElementById('quickEndTime');
    const timeInterval = document.getElementById('timeInterval');
    const applyTimeRange = document.getElementById('applyTimeRange');

    function generateTimeSlots(startTime, endTime, interval) {
        const slots = [];
        let current = new Date(`2000-01-01 ${startTime}`);
        const end = new Date(`2000-01-01 ${endTime}`);
        
        while (current < end) {
            slots.push(current.toTimeString().substring(0, 5));
            current.setMinutes(current.getMinutes() + parseInt(interval));
        }
        
        return slots;
    }

    if (applyTimeRange) {
        applyTimeRange.addEventListener('click', function() {
            const startTime = quickStartTime.value;
            const endTime = quickEndTime.value;
            const interval = parseInt(timeInterval.value);

            if (!startTime || !endTime) {
                alert('Please select both start and end times');
                return;
            }

            const slots = generateTimeSlots(startTime, endTime, interval);
            const selectedDay = document.querySelector('.availability-day .day-checkbox:checked');
            
            if (!selectedDay) {
                alert('Please select at least one day');
                return;
            }

            const dayContainer = selectedDay.closest('.availability-day');
            const slotsContainer = dayContainer.querySelector('.selected-slots');
            slotsContainer.innerHTML = ''; // Clear existing slots
            
            slots.forEach(slot => {
                addTimeSlotElement(slotsContainer, slot, dayContainer.dataset.day);
            });
            
            updateAvailabilityInput();
        });
    }

    // Copy to all days functionality
    const copyToAllDays = document.getElementById('copyToAllDays');
    if (copyToAllDays) {
        copyToAllDays.addEventListener('click', function() {
            const checkedDay = document.querySelector('.availability-day .day-checkbox:checked');
            if (!checkedDay) {
                alert('Please select at least one day to copy from');
                return;
            }

            const sourceContainer = checkedDay.closest('.availability-day');
            const sourceSlots = Array.from(sourceContainer.querySelectorAll('.selected-slots .badge'))
                .map(slot => slot.textContent.trim().split('\n')[0].trim());

            document.querySelectorAll('.availability-day').forEach(dayContainer => {
                if (dayContainer !== sourceContainer) {
                    const checkbox = dayContainer.querySelector('.day-checkbox');
                    checkbox.checked = true;
                    
                    const slotsContainer = dayContainer.querySelector('.selected-slots');
                    slotsContainer.innerHTML = ''; // Clear existing slots
                    
                    sourceSlots.forEach(slot => {
                        addTimeSlotElement(slotsContainer, slot, dayContainer.dataset.day);
                    });
                }
            });
            
            updateAvailabilityInput();
        });
    }

    // Clear all functionality
    const clearAll = document.getElementById('clearAll');
    if (clearAll) {
        clearAll.addEventListener('click', function() {
            document.querySelectorAll('.availability-day').forEach(dayContainer => {
                const checkbox = dayContainer.querySelector('.day-checkbox');
                checkbox.checked = false;
                
                const slotsContainer = dayContainer.querySelector('.selected-slots');
                slotsContainer.innerHTML = '';
            });
            
            updateAvailabilityInput();
        });
    }

    // Copy individual day functionality
    document.querySelectorAll('.copy-day').forEach(button => {
        button.addEventListener('click', function() {
            const dayContainer = this.closest('.availability-day');
            const day = dayContainer.dataset.day;
            const slots = availabilityData[day];

            if (slots.length === 0) {
                alert('Please add some time slots to copy');
                return;
            }

            localStorage.setItem('copiedSchedule', JSON.stringify(slots));
            alert('Schedule copied! You can now paste it to other days.');
        });
    });

    // Clear individual day functionality
    document.querySelectorAll('.clear-day').forEach(button => {
        button.addEventListener('click', function() {
            const dayContainer = this.closest('.availability-day');
            const day = dayContainer.dataset.day;
            const slotsContainer = dayContainer.querySelector('.selected-slots');
            
            availabilityData[day] = [];
            slotsContainer.innerHTML = '';
            updateAvailabilityInput();
        });
    });

    function addTimeSlotElement(container, time, day) {
        const slot = document.createElement('div');
        slot.className = 'badge bg-primary me-2 mb-2 p-2';
        slot.innerHTML = `
            ${time}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    style="font-size: 0.5em;" aria-label="Remove"></button>
        `;
        
        slot.querySelector('.btn-close').addEventListener('click', function() {
            slot.remove();
            updateAvailabilityInput();
        });
        
        container.appendChild(slot);
        updateAvailabilityInput();
    }

    function updateAvailabilityInput() {
        // Get all day containers
        const dayContainers = document.querySelectorAll('.availability-day');
        const availabilityData = {};

        dayContainers.forEach(container => {
            const day = container.dataset.day;
            const isChecked = container.querySelector('.day-checkbox').checked;
            const slots = [];

            // Only collect slots if the day is checked
            if (isChecked) {
                container.querySelectorAll('.selected-slots .badge').forEach(slot => {
                    const time = slot.textContent.trim().split('\n')[0].trim();
                    if (time) {
                        slots.push(time);
                    }
                });
            }

            // Always include the day in the data
            availabilityData[day] = slots;
        });

        // Update the hidden input
        document.getElementById('availability').value = JSON.stringify(availabilityData);
        console.log('Updated availability:', availabilityData);
    }

    // Add event listeners for day checkboxes
    document.querySelectorAll('.day-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const dayContainer = this.closest('.availability-day');
            const slotsContainer = dayContainer.querySelector('.selected-slots');
            
            if (!this.checked) {
                // Clear slots when day is unchecked
                slotsContainer.innerHTML = '';
            }
            
            // Update the availability input
            updateAvailabilityInput();
        });
    });

    // Real-time form validation
    const form = document.querySelector('.needs-validation');
    const inputs = form.querySelectorAll('input, select, textarea');
    const roleSelect = document.getElementById('role');

    // Validation patterns and messages
    const validations = {
        name: {
            pattern: /^[A-Za-z\s]{2,100}$/,
            message: 'Name must be 2-100 characters long and contain only letters and spaces'
        },
        email: {
            pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            message: 'Please enter a valid email address'
        },
        mobile_number: {
            pattern: /^[0-9]{10}$/,
            message: 'Mobile number must be exactly 10 digits'
        },
        aadhar_number: {
            pattern: /^[0-9]{12}$/,
            message: 'Aadhar number must be exactly 12 digits'
        },
        pin_code: {
            pattern: /^[0-9]{6}$/,
            message: 'PIN code must be exactly 6 digits'
        },
        password: {
            pattern: /.{8,}/,
            message: 'Password must be at least 8 characters long'
        }
    };

    // Function to validate a single input
    function validateInput(input) {
        const validation = validations[input.name];
        let isValid = true;
        let message = '';

        // Clear previous validation state
        input.classList.remove('is-invalid', 'is-valid');
        
        // Skip validation if field is empty and not required
        if (!input.required && !input.value) {
            return true;
        }

        // Required field validation
        if (input.required && !input.value) {
            isValid = false;
            message = 'This field is required';
        }
        // Pattern validation if exists
        else if (validation && validation.pattern) {
            isValid = validation.pattern.test(input.value);
            message = validation.message;
        }
        // Select validation
        else if (input.tagName === 'SELECT' && input.required) {
            isValid = input.value !== '';
            message = 'Please select an option';
        }
        // Date validation
        else if (input.type === 'date' && input.required) {
            isValid = input.value !== '';
            message = 'Please select a date';
        }

        // Update validation state
        if (!isValid) {
            input.classList.add('is-invalid');
            const feedback = input.nextElementSibling?.classList.contains('invalid-feedback') 
                ? input.nextElementSibling 
                : document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = message;
            if (!input.nextElementSibling?.classList.contains('invalid-feedback')) {
                input.parentNode.appendChild(feedback);
            }
        } else {
            input.classList.add('is-valid');
        }

        return isValid;
    }

    // Function to validate role-specific fields
    function validateRoleFields() {
        const role = roleSelect.value;
        let isValid = true;

        if (role === 'patient') {
            const patientFields = [
                'patient_number', 'mobile_number', 'date_of_birth',
                'aadhar_number', 'address', 'state', 'city', 'pin_code'
            ];
            patientFields.forEach(fieldName => {
                const input = form.querySelector(`[name="${fieldName}"]`);
                if (input) {
                    input.required = true;
                    if (!validateInput(input)) {
                        isValid = false;
                    }
                }
            });
        } else if (role === 'doctor') {
            const doctorFields = ['specialization'];
            doctorFields.forEach(fieldName => {
                const input = form.querySelector(`[name="${fieldName}"]`);
                if (input) {
                    input.required = true;
                    if (!validateInput(input)) {
                        isValid = false;
                    }
                }
            });
        }

        return isValid;
    }

    // Add real-time validation to all inputs
    inputs.forEach(input => {
        ['input', 'blur', 'change'].forEach(eventType => {
            input.addEventListener(eventType, () => {
                validateInput(input);
            });
        });
    });

    // Role change handler
    roleSelect.addEventListener('change', function() {
        // Reset all fields
        inputs.forEach(input => {
            input.required = false;
            input.classList.remove('is-invalid', 'is-valid');
            const feedback = input.nextElementSibling;
            if (feedback?.classList.contains('invalid-feedback')) {
                feedback.remove();
            }
        });

        // Show/hide fields based on role
        const patientFields = document.getElementById('patient-fields');
        const doctorFields = document.getElementById('doctor-fields');
        
        if (this.value === 'patient') {
            patientFields.classList.remove('d-none');
            doctorFields.classList.add('d-none');
        } else if (this.value === 'doctor') {
            doctorFields.classList.remove('d-none');
            patientFields.classList.add('d-none');
        } else {
            patientFields.classList.add('d-none');
            doctorFields.classList.add('d-none');
        }

        // Validate visible fields
        validateRoleFields();
    });

    // Form submission handler
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        let isValid = true;

        // Validate all visible required fields
        inputs.forEach(input => {
            if (!input.closest('.d-none') && !validateInput(input)) {
                isValid = false;
            }
        });

        // Validate role-specific fields
        if (!validateRoleFields()) {
            isValid = false;
        }

        if (isValid) {
            this.submit();
        } else {
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,.125);
}

.selected-slots {
    min-height: 38px;
    padding: 5px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

.btn-close {
    padding: 0.25rem;
    font-size: 0.5rem;
}

.availability-day {
    border: 1px solid rgba(0,0,0,.125);
    margin-bottom: 1rem;
}

.availability-day .card-header {
    background-color: #f8f9fa;
}

.input-group-text {
    background-color: #f8f9fa;
    border-right: none;
}

.input-group .form-control {
    border-left: none;
}

.input-group .form-control:focus {
    border-color: #dee2e6;
    box-shadow: none;
}

.form-label {
    color: #495057;
    margin-bottom: 0.5rem;
}

.breadcrumb {
    font-size: 0.875rem;
}

.breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: #0d6efd;
}

.form-switch .form-check-input {
    width: 3em;
    height: 1.5em;
    margin-top: 0.25em;
}

.btn {
    padding: 0.5rem 1rem;
    font-weight: 500;
}

.btn-group > .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Add validation styles */
.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-valid,
.form-select.is-valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.was-validated .form-control:invalid,
.form-control.is-invalid {
    border-color: #dc3545;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-feedback {
    display: block;
}
</style>
{% endblock %} 